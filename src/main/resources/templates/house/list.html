<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>查询房源</title>
    <link th:href="@{/lib/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/lib/bootstrap-table/bootstrap-table.min.css}" rel="stylesheet">
</head>
<body>
<!--  查询条件  -->
<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
    <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="headingOne">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                    查询条件
                </a>
            </h4>
        </div>
        <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
            <div class="panel-body">
                <form class="form-horizontal" role="form">
                    <!-- 省市区  start-->
                    <div class="form-group">
                        <lable class="col-md-1 control-label">所在省</lable>
                        <div class="col-md-2">
                            <select id="province" name="province" class="form-control">
                                <option value="">--请选择--</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <lable class="col-md-1 control-label">所在市</lable>
                        <div class="col-md-2">
                            <select id="city" name="city" class="form-control">
                                <option value="">--请选择--</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <lable class="col-md-1 control-label">所在区(县)</lable>
                        <div class="col-md-2">
                            <select id="area" name="area" class="form-control">
                                <option value="">--请选择--</option>
                            </select>
                        </div>
                    </div>
                    <!--省市区 end-->
                    <!--租赁方式 单选框-->
                    <div class="form-group">
                        <label class="col-md-1 control-label">方式</label>
                        <div class="col-md-6" id="rent_mode">
                            <label class="radio-inline">
                                <input type="radio" name="rentMode" value="" checked> 不限
                            </label>
                        </div>
                    </div>

                    <!--租金范围-->
                    <div class="form-group">
                        <label class="col-md-1 control-label">租金</label>
                        <div class="col-md-10">
                            <label class="checkbox-inline">
                                <input type='checkbox'name="rental" value="100-1000"><=1000元
                            </label>
                            <label class="checkbox-inline">
                                <input type='checkbox'name="rental" value="1000-1500">1000 ~ 1500元
                            </label>
                            <label class="checkbox-inline">
                                <input type='checkbox'name="rental" value="1500-2500">1500 ~ 2500元
                            </label>
                            <label class="checkbox-inline">
                                <input type='checkbox'name="rental" value="2500-5000">2000 ~ 5000元
                            </label>
                            <label class="checkbox-inline">
                                <input type='checkbox' name="rental" value="5000-1000000">5000元以上
                            </label>

                        </div>
                    </div>
                    <!--户型-->
                    <div class="form-group">
                        <label class="col-md-1 control-label">户型</label>
                        <div class="col-md-6" id="house_type">

                        </div>
                    </div>


                    <!--朝向-->
                    <div class="form-group">
                        <label class="col-md-1 control-label">朝向</label>
                        <div class="col-md-6" id="orientation">

                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-3">
                            <button id="queryBtn" type="button" class="btn btn-primary">查询</button>
                            <button id="reset"  class="btn btn-primary">重置</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<table id="listTable"></table>



<script th:src="@{/lib/js/jquery/jquery.min.js}" type="text/javascript"></script>
<script th:src="@{/lib/bootstrap/js/bootstrap.min.js}" type="text/javascript"></script>
<script th:src="@{/lib/bootstrap-table/bootstrap-table.min.js}" type="text/javascript"></script>
<script th:src="@{/lib/bootstrap-table/bootstrap-table-zh-CN.min.js}" type="text/javascript"></script>
<script th:inline="javascript">
    const path =[[${#request.getContextPath()}]];
    const option='<option value="">--请选择--</option>';
    //页面加载完毕
    $(function () {
        House.queryList();
        //省市级连
        House.queryArea('province',0);
        $('#province').change(function(){
            $("#city").html(option);
            $("#area").html(option);
           if(this.value){
               House.queryArea('city',this.value);
           }
        });
        $('#city').change(function(){
            $("#area").html(option);
            if(this.value){
                House.queryArea('area',this.value);
            }
        });

        //查询按钮
        $('#queryBtn').click(function () {
            $('#listTable').bootstrapTable('refresh');
        });
        //租赁方式
        House.queryRentMode();
        //查询户型和朝向
        House.getQueryPanelDict("house_type");
        House.getQueryPanelDict("orientation");
    });

    let House ={
        queryList:function () {
            $('#listTable').bootstrapTable({
                url: path+'/house/list',// 请求后台的URL（*）
                pagination: true,
                sidePagination: 'server',//服务端处理分页
                pageNumber: 1,
                pageSize: 10,
                pageList: [2,5,7,10],//每页显示多少条
                queryParamsType: 'undefined',
                paginationPreText: '上一页',
                paginationLastText: '下一页',
                queryParams: function(params) { // 参数
                    // 获取租赁方式  下拉菜单
                    let rentMode = $("input[name='rentMode']:checked").val();
                    //定义户型参数  多选框
                    let houseTypeList=[];
                    $("input[name='house_type']:checked").each(function () {
                        houseTypeList.push(this.value);
                    })
                    let orientationList=[];
                    $("input[name='orientation']:checked").each(function () {
                        orientationList.unshift(this.value);
                    });
                    let rentalList=[];
                    $("input[name='rental']:checked").each(function () {
                        rentalList.push(this.value);
                    })
                    let newParam = {
                        pageNum: params.pageNumber,
                        pageSize: params.pageSize,
                        // 省市区查询条件
                        province: $('#province').val(),
                        city: $('#city').val(),
                        area: $('#area').val(),
                        rentMode: rentMode,
                        orientationList:orientationList.join(','),//将数组中得元素用“,” 分割拼接
                        houseTypeList:houseTypeList.join(','),
                        rentalList:rentalList // 传入后端格式：rentalList[]: 100-1000  rentalList[]: 1000-1500
                    };
                    return newParam;
                },
                columns:[
                    {field:'id',title:'编号'},
                    {field:'areaName',title:'所在区'},
                    {field:'rentModeName',title:'租赁方式'},
                    {field:'houseTypeName',title:'户型'},
                    {field:'orientationName',title:'朝向'},
                    {field:'address',title:'地址'},
                    {field:'rental',title:'价格'},
                    {title:'图片',formatter: function (value,row,index) {
                            return "<img width='50px' height='50px' src='"+path+row.pic+"' />";
                        }
                    },
                    {title: '操作',formatter: function (value,row,index) {
                            return "更新";
                        }
                    },
                ]

            })
        },
        //省市区级联查寻
        queryArea:function (domId,pid) {
            $.ajax({
                url:path+"/area/queryByPid",
                type:'get',
                dataType: 'json',
                data:'pid='+pid,
                success:function (res) {
                    let options="<option value=\"\">--请选择--</option>"
                    $.each(res,function (index,area) {
                        options+="<option value='"+area.id+"'>"
                            +area.name
                            + "</option>"
                    });
                    $("#"+domId).html(options);
                }
            })
        },
        //租赁方式
        queryRentMode:function () {
            $.ajax({
                url:path+"/dict/rent_mode",
                type:'get',
                data:'',
                dataType: 'json',
                success:function (res) {
                    console.log(res);
                    let radios = '';
                    for(let i in res) {
                        let showName = res[i].name;
                        let radioValue = res[i].value;
                        radios += "<label class='radio-inline'>"
                            + "<input type='radio' name='rentMode' value='" +radioValue+ "'>" + showName
                            + "</label>";
                    }
                    $('#rent_mode').append(radios);
                }
            })
        },
        getQueryPanelDict: function(groupId) {
            $.ajax({
                url:path+"/dict/"+groupId,
                type:'get',
                data:'',
                dataType:'json',
                success:function (res) {
                    let checkboxStr='';
                    $.each(res,function (index,dict) {
                        checkboxStr+="<label class='checkbox-inline'>"
                            + "<input type='checkbox' name='"+groupId+"' value='"+dict.value+"'>"
                            +dict.name
                            + "</label>"
                    });
                    $("#"+groupId).html(checkboxStr);
                }
            });
        },


    }

</script>
</body>
</html>